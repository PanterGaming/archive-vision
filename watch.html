<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArchiveVision - Watch Video</title>
    <link rel="icon" type="image/png" href="tv.png">
    <style>
        body {
            font-family: Arial, Verdana, sans-serif;
            background: #f5e8d3;
            margin: 0;
            padding: 20px 0;
            color: #333;
        }
        #container {
            width: 960px;
            margin: 0 auto;
            background: #fff;
            border: 2px solid #e0c8a8;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        #header {
            background: linear-gradient(45deg, #ff4d4d, #ff8c1a);
            color: #fff;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #cc4c4c;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-radius: 8px 8px 0 0;
        }
        #header img.logo {
            width: 100px;
            height: auto;
            margin-bottom: 15px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }
        #header img.logo:hover {
            transform: scale(1.1);
        }
        #header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }
        #main {
            float: left;
            width: 660px;
            padding: 20px;
        }
        #player {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 5px;
            overflow: hidden;
        }
        #video-info {
            padding: 15px 0;
        }
        #video-info h2 {
            margin: 0;
            font-size: 20px;
            color: #d2691e;
            font-weight: bold;
        }
        #video-info p {
            margin: 5px 0;
            font-size: 14px;
            font-style: italic;
            color: #555;
        }
        .unavailable {
            padding: 15px;
            font-size: 16px;
            color: #ff4500;
            text-align: center;
        }
        #sidebar {
            float: right;
            width: 280px;
            padding: 20px;
            background: #f9f1e0;
            border-left: 2px solid #e0c8a8;
        }
        .suggested-item {
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }
        .suggested-item:hover {
            transform: translateX(5px);
        }
        .suggested-item img {
            width: 140px;
            height: 80px;
            float: left;
            margin-right: 10px;
            border: 2px solid #e0c8a8;
            border-radius: 4px;
        }
        .suggested-item h3 {
            font-size: 13px;
            margin: 0;
            color: #d2691e;
            text-decoration: underline;
            transition: color 0.3s ease;
        }
        .suggested-item h3:hover {
            color: #ff4500;
        }
        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }
        a.back-link {
            display: inline-block;
            margin: 10px 20px;
            color: #d2691e;
            text-decoration: underline;
            font-size: 15px;
            transition: color 0.3s ease;
        }
        a.back-link:hover {
            color: #ff4500;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="header">
            <img src="tv.png" alt="ArchiveVision Logo" class="logo">
            <h1>ArchiveVision: Watch Pre-2015 Video</h1>
        </div>
        <a class="back-link" href="index.html">Back to Search</a>
        <div id="main">
            <div id="player"></div>
            <div id="video-info"></div>
        </div>
        <div id="sidebar" class="clearfix"></div>
    </div>

    <script>
        const API_KEY = 'AIzaSyBUrV51VYozfgGdYNo1XNBnF0cj15DS4XM';
        const BASE_URL = 'https://www.googleapis.com/youtube/v3';

        async function loadVideo() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('videoId');
            const searchTerm = urlParams.get('searchTerm') || '';
            if (!videoId) {
                document.getElementById('video-info').innerHTML = '<p>Error: No video ID provided. Check the URL (e.g., ?videoId=VALID_ID).</p>';
                return;
            }

            // Load video details and check availability
            try {
                const videoResponse = await fetch(`${BASE_URL}/videos?part=snippet,status&id=${videoId}&key=${API_KEY}`);
                const videoData = await videoResponse.json();
                if (videoData.error) {
                    console.error('API Error:', videoData.error);
                    document.getElementById('video-info').innerHTML = `<p>API Error: ${videoData.error.message}. Check your API key or quota.</p>`;
                    return;
                }
                if (!videoData.items || videoData.items.length === 0) {
                    console.error('No video data found for ID:', videoId);
                    document.getElementById('video-info').innerHTML = `<p>No details found for video ID: ${videoId}</p>`;
                    return;
                }
                const video = videoData.items[0];
                const status = video.status;
                if (!status.embeddable || status.privacyStatus !== 'public') {
                    console.warn(`Video ${videoId} is not embeddable or public.`);
                    document.getElementById('player').innerHTML = `<div class="unavailable">Video unavailable - <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank">Watch on YouTube</a></div>`;
                    document.getElementById('video-info').innerHTML = '';
                    return;
                }
                const title = video.snippet.title;
                const description = video.snippet.description.slice(0, 200) + '...';

                document.getElementById('player').innerHTML = `
                    <iframe width="100%" height="100%" 
                        src="https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&playsinline=1" 
                        title="YouTube video player" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                        referrerpolicy="strict-origin-when-cross-origin" 
                        allowfullscreen loading="lazy"></iframe>
                `;
                document.getElementById('video-info').innerHTML = `
                    <h2>${title}</h2>
                    <p>${description}</p>
                `;

                // Error 153 fallback with manual link
                const iframe = document.querySelector('#player iframe');
                iframe.addEventListener('load', function() {
                    setTimeout(() => {
                        if (iframe.contentDocument && iframe.contentDocument.body.innerText.includes('Video unavailable')) {
                            document.getElementById('player').innerHTML = `<div class="unavailable">Video unavailable - <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank">Watch on YouTube</a></div>`;
                        }
                    }, 2000);
                });
            } catch (error) {
                console.error('Fetch Error:', error);
                document.getElementById('video-info').innerHTML = `<p>Error loading video details. Video ID: ${videoId}. Check console for details.</p>`;
            }

            // Load suggested videos based on search term
            try {
                const searchResponse = await fetch(`${BASE_URL}/search?part=snippet&q=${encodeURIComponent(searchTerm)}&type=video&publishedBefore=2015-01-01T00:00:00Z&maxResults=5&key=${API_KEY}`);
                const searchData = await searchResponse.json();
                if (searchData.error) {
                    console.error('Search API Error:', searchData.error);
                    document.getElementById('sidebar').innerHTML = '<p>Failed to load suggestions due to an API error.</p>';
                    return;
                }
                if (!searchData.items || searchData.items.length === 0) {
                    document.getElementById('sidebar').innerHTML = `<p>No suggestions found for "${searchTerm}". Try a different search!</p>`;
                    return;
                }

                const sidebar = document.getElementById('sidebar');
                sidebar.innerHTML = '<h3>Suggested Videos</h3>';
                searchData.items.forEach(item => {
                    const relatedId = item.id.videoId;
                    const relatedTitle = item.snippet.title;
                    const thumbnail = item.snippet.thumbnails.default.url;

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'suggested-item clearfix';
                    itemDiv.innerHTML = `
                        <img src="${thumbnail}" alt="${relatedTitle}">
                        <h3 onclick="window.location.href='watch.html?videoId=${relatedId}&searchTerm=${encodeURIComponent(searchTerm)}'">${relatedTitle}</h3>
                    `;
                    sidebar.appendChild(itemDiv);
                });
            } catch (error) {
                console.error('Suggestions Fetch Error:', error);
                document.getElementById('sidebar').innerHTML = '<p>Error loading suggested videos. Check your internet or API key.</p>';
            }
        }

        loadVideo();
    </script>
</body>
</html>
